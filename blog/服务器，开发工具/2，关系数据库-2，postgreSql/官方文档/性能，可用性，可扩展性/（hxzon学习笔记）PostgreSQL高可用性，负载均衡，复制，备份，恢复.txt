（hxzon学习笔记）PostgreSQL高可用性，负载均衡，复制，备份，恢复

by hxzon
《Chapter 25. 高可用性与负载均衡，复制（PostgreSQL 9.0.4 中文文档）》
==========
1，“写同步问题”就是导致多台服务器协同工作麻烦重重的最基本原因。

2，
仅在失效切换后代替主服务器的"备用"服务器。 
跟踪“主”服务器数据变化的叫“备”或“从”服务器。
备用服务器不能连接到主服务器， 直到它晋升为“暖备”服务器。
可以接受连接而且只读服务器称为“热备”服务器。

3，
共享磁盘：只保存一份数据。如果磁盘坏了，整个系统瘫痪。

文件系统复制（块设备）：
DRBD是Linux上的一种流行的文件系统复制方案。

使用即时恢复(PITR)的热备份
热备份服务器可以通过读取WAL记录流来保持数据库的当前状态。
这是一个异步方案。

使用基于文件的日志传送或流复制，或两者相结合实现PITR备份服务器。

基于“触发器”的主备复制
Slony-I是这个方案的一个例子。

基于语句的复制
有些语句的执行结果不一定相同，例如随机数，自动主键。
Pgpool-II和Sequoia是这种方案的实例。

异步，多主复制
每台服务器都独立工作，并周期性通信，
由用户来判决冲突。

同步，多主复制
每台服务器修改的数据，先广播到其它服务器，再提交。
适用于读多写少的场景。
PostgreSQL不提供这种类型的复制。 
但是PostgreSQL的两阶段提交(PREPARE TRANSACTION和COMMIT PREPARED)
可以用于在应用层或中间件代码中实现这个功能。

数据分区
每个子集只有一台服务器可以修改。
每台服务器可以提供其它子集的只读副本。

多服务器并行执行查询
多个服务器各自执行查询的一部分， 
并将结果返回到中央服务器，由中央服务器来联合结果并返回给用户。
Pgpool-II有这种能力。 
也可以使用PL/Proxy工具集实现。

hxzon：广播到其它服务器时，可以只写入内存。

========
4，日志传送

只能用于灾难恢复，而不能提供高可用性。

虽然主服务器和备份服务器只是松散的耦合在一起，但它们必须同时运行。 
主服务器以"连续归档"模式运行，
备份服务器以"连续恢复"模式运行并从主服务器"不停的读取WAL文件"。 
因为数据库的表无需为此进行任何改变，
所以与其它复制方法相比，额外的管理开销很小。 
并且这种方法对主服务器的性能影响也很小。

直接移动WAL或在数据库服务器之间"传送"日志记录通常被称为日志传送(LogShipping)。 
PostgreSQL实现了“基于文件”的日志传送，意思是WAL记录每次移动一个完整的文件(WAL段)。 
WAL文件可以被轻易的在任意两个地点之间传送，不管是与邻近的系统还是地球另一面的系统。 
所需带宽取决于主服务器的事务发生速度。 
基于记录的日志传送也可以通过Section 25.2.5中讨论的自定义过程实现。

因为不停的执行恢复过程，备份服务器在通常情况下是不能被访问的。 
由于恢复速度非常快，备份服务器通常在启用后只有很短的时间不能使用。 
所以这个方案只能用于灾难恢复而不能用于提供高可用性。

==
备服务器可以从一个WAL归档（参阅restore_command）或 直接通过一个TCP连接（流复制）从主服务器上读取WAL。
备服务器也可以在备用集群pg_xlog尝试查找恢复任何WAL。 

==
流复制

与基于文件日志传送相比，流复制允许保持备服务器更新。 
备服务器连接主服务器，其产生的流WAL记录到备服务器，而不需要等待填写WAL文件。

流复制是异步的，所以在主事务提交和变化成为在备服务器可见之间,还有一个小的延迟。 
这个延迟远小于基于文件日志传送，通常1秒内足够与负载保持。
使用流复制，为减少数据丢失窗口 archive_timeout不是必要的。

在主服务器上设置listen_addresses和身份验证选项（见pg_hba.conf），
因此备用服务器 可以连接到在主服务器的replication伪数据库（参阅Section 25.2.5.1）。

流复制的一个重要的健康指标是在主服务器生成的WAL记录数，而不是在备服务器应用的数量。 
通过比较在主服务器当前WAL写的位置和备服务器收到的最后一个WAL位置，就可以计算出这种滞后。 
在主服务器上使用pg_current_xlog_location和
在备服务器上使用pg_last_xlog_receive_location 可以分别检索到它们（参阅Table 9-56和Table 9-57关于详细信息）。	 
在备服务器收到最后的WAL位置也会进程状态的WAL接收进程显示，使用ps命令显示（参阅Section 27.1关于详细信息）。

==
基于记录的日志传送（需自己定制开发）

========
5，失效切换








